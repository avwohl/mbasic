
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Complete documentation for MBASIC 5.21 interpreter - MBASIC-80 for CP/M implemented in Python (includes developer docs)">
      
      
        <meta name="author" content="MBASIC Project Contributors">
      
      
        <link rel="canonical" href="https://avwohl.github.io/mbasic/history/PRESERVE_ORIGINAL_SPACING_DONE/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Preserve Original Spacing in AST Serialization - MBASIC 5.21 Documentation (Full)</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#preserve-original-spacing-in-ast-serialization" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MBASIC 5.21 Documentation (Full)" class="md-header__button md-logo" aria-label="MBASIC 5.21 Documentation (Full)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MBASIC 5.21 Documentation (Full)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Preserve Original Spacing in AST Serialization
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/avwohl/mbasic" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    avwohl/mbasic
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../library/" class="md-tabs__link">
          
  
  
  Library

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MBASIC 5.21 Documentation (Full)" class="md-nav__button md-logo" aria-label="MBASIC 5.21 Documentation (Full)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MBASIC 5.21 Documentation (Full)
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/avwohl/mbasic" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    avwohl/mbasic
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Library
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MBASIC Program Library
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/games/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Games
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/utilities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utilities
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/education/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Education
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/business/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Business
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/electronics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Electronics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/ham_radio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ham Radio
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/data_management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/telecommunications/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Telecommunications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../library/demos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Demos
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem" class="md-nav__link">
    <span class="md-ellipsis">
      Problem
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-insight-token-positions-available" class="md-nav__link">
    <span class="md-ellipsis">
      Key Insight: Token Positions Available
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proposed-solution" class="md-nav__link">
    <span class="md-ellipsis">
      Proposed Solution
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposed Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-token-positions-to-preserve-spacing" class="md-nav__link">
    <span class="md-ellipsis">
      Use Token Positions to Preserve Spacing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#current-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Current Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Current Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lexer-already-tracks-positions" class="md-nav__link">
    <span class="md-ellipsis">
      Lexer (Already Tracks Positions)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parser-stores-tokens-in-ast" class="md-nav__link">
    <span class="md-ellipsis">
      Parser (Stores Tokens in AST)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serializer-currently-pretty-prints" class="md-nav__link">
    <span class="md-ellipsis">
      Serializer (Currently Pretty Prints)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#phase-1-update-serialization-to-use-positions" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 1: Update Serialization to Use Positions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-2-store-token-sequences-in-ast-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 2: Store Token Sequences in AST Nodes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-3-handle-edge-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 3: Handle Edge Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-4-fallback-for-generated-code" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 4: Fallback for Generated Code
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#phase-5-handle-renum-special-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Phase 5: Handle RENUM Special Cases
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Benefits
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Benefits">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-preserves-user-intent" class="md-nav__link">
    <span class="md-ellipsis">
      1. Preserves User Intent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-no-surprising-changes" class="md-nav__link">
    <span class="md-ellipsis">
      2. No Surprising Changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-respects-coding-style" class="md-nav__link">
    <span class="md-ellipsis">
      3. Respects Coding Style
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-related-to-case-preservation" class="md-nav__link">
    <span class="md-ellipsis">
      4. Related to Case Preservation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#comparison-with-pretty-printing" class="md-nav__link">
    <span class="md-ellipsis">
      Comparison with Pretty Printing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Comparison with Pretty Printing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#current-pretty-print-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Current (Pretty Print) Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proposed-position-based-approach" class="md-nav__link">
    <span class="md-ellipsis">
      Proposed (Position-Based) Approach
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#related-todos" class="md-nav__link">
    <span class="md-ellipsis">
      Related TODOs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Related TODOs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pretty_printer_spacing_todomd" class="md-nav__link">
    <span class="md-ellipsis">
      PRETTY_PRINTER_SPACING_TODO.md
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type_suffix_serialization-completed-v1085" class="md-nav__link">
    <span class="md-ellipsis">
      TYPE_SUFFIX_SERIALIZATION (Completed v1.0.85)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case_preserving_variables_todomd" class="md-nav__link">
    <span class="md-ellipsis">
      CASE_PRESERVING_VARIABLES_TODO.md
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-plan" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Plan
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing Plan">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Test Cases
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integration-tests" class="md-nav__link">
    <span class="md-ellipsis">
      Integration Tests
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-files" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Files
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Files">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#files-to-modify" class="md-nav__link">
    <span class="md-ellipsis">
      Files to Modify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#files-to-create" class="md-nav__link">
    <span class="md-ellipsis">
      Files to Create
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#files-to-update-related" class="md-nav__link">
    <span class="md-ellipsis">
      Files to Update (Related)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migration-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Migration Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Migration Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-verify-token-positions-exist" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Verify Token Positions Exist
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-add-token-storage-to-ast" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Add Token Storage to AST
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-implement-position-based-serialization" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Implement Position-Based Serialization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-add-fallback" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Add Fallback
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-roll-out-to-all-statements" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5: Roll Out to All Statements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-integration-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Step 6: Integration Testing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Considerations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#success-criteria" class="md-nav__link">
    <span class="md-ellipsis">
      Success Criteria
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#historical-context" class="md-nav__link">
    <span class="md-ellipsis">
      Historical Context
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Historical Context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#classic-basic-interpreters" class="md-nav__link">
    <span class="md-ellipsis">
      Classic BASIC Interpreters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#priority-justification" class="md-nav__link">
    <span class="md-ellipsis">
      Priority Justification
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Notes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/avwohl/mbasic/edit/main/docs/history/PRESERVE_ORIGINAL_SPACING_DONE.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="preserve-original-spacing-in-ast-serialization">Preserve Original Spacing in AST Serialization<a class="headerlink" href="#preserve-original-spacing-in-ast-serialization" title="Permanent link">&para;</a></h1>
<p>⏳ <strong>Status:</strong> TODO</p>
<p><strong>Priority:</strong> HIGH - Critical for maintaining user's code formatting</p>
<h2 id="problem">Problem<a class="headerlink" href="#problem" title="Permanent link">&para;</a></h2>
<p>Currently, when serializing the AST back to source code, we use pretty printing which adds standardized spacing. This <strong>loses the user's original formatting</strong>.</p>
<p><strong>Example - Current behavior (WRONG):</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="vg">User</span><span class="w"> </span><span class="nl">types:</span><span class="w">    </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="vg">Y</span><span class="o">+</span><span class="il">3</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="vg">Saved</span><span class="w"> </span><span class="nl">as:</span><span class="w">      </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span>
</code></pre></div></p>
<p>The user's compact spacing is replaced with standardized spacing.</p>
<h2 id="key-insight-token-positions-available">Key Insight: Token Positions Available<a class="headerlink" href="#key-insight-token-positions-available" title="Permanent link">&para;</a></h2>
<p><strong>We already have the information we need!</strong> The lexer captures character positions for each token:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Token</span><span class="p">:</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>      <span class="c1"># Line number in source</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>  <span class="c1"># Character position in line</span>
</code></pre></div>
<p><strong>This means we can reconstruct the exact original spacing!</strong></p>
<h2 id="proposed-solution">Proposed Solution<a class="headerlink" href="#proposed-solution" title="Permanent link">&para;</a></h2>
<h3 id="use-token-positions-to-preserve-spacing">Use Token Positions to Preserve Spacing<a class="headerlink" href="#use-token-positions-to-preserve-spacing" title="Permanent link">&para;</a></h3>
<p>Instead of pretty printing with fixed spacing rules, use the column positions from tokens to reconstruct the original spacing.</p>
<p><strong>Algorithm:</strong>
1. For each token in the AST node, we know its original column position
2. When serializing, calculate spaces needed between tokens
3. Output exact spacing from original source</p>
<p><strong>Example:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Original line: &quot;10 X=Y+3&quot;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c1"># Token positions:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1">#   &quot;10&quot;  -&gt; column 0</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1">#   &quot;X&quot;   -&gt; column 3</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1">#   &quot;=&quot;   -&gt; column 4</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="c1">#   &quot;Y&quot;   -&gt; column 5</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1">#   &quot;+&quot;   -&gt; column 6</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1">#   &quot;3&quot;   -&gt; column 7</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="c1"># Serialization:</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="n">prev_end</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>    <span class="n">spaces</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">-</span> <span class="n">prev_end</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>    <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">spaces</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="n">prev_end</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="c1"># Result: &quot;10 X=Y+3&quot; ✅ Exact original!</span>
</code></pre></div></p>
<h2 id="current-architecture">Current Architecture<a class="headerlink" href="#current-architecture" title="Permanent link">&para;</a></h2>
<h3 id="lexer-already-tracks-positions">Lexer (Already Tracks Positions)<a class="headerlink" href="#lexer-already-tracks-positions" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># In lexer.py - already implemented!</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="n">column</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>        <span class="c1"># Create token with position</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>        <span class="n">column</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>
<p><strong>Status:</strong> ✅ Column tracking already exists in lexer</p>
<h3 id="parser-stores-tokens-in-ast">Parser (Stores Tokens in AST)<a class="headerlink" href="#parser-stores-tokens-in-ast" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># In parser.py - tokens stored in AST nodes</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">BinaryOpNode</span><span class="p">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>          <span class="c1"># Token with position!</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
</code></pre></div>
<p><strong>Status:</strong> ✅ Tokens with positions already in AST</p>
<h3 id="serializer-currently-pretty-prints">Serializer (Currently Pretty Prints)<a class="headerlink" href="#serializer-currently-pretty-prints" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># In ui_helpers.py - currently IGNORES positions</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">serialize_binary_op</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>    <span class="n">left</span> <span class="o">=</span> <span class="n">serialize_expression</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>    <span class="n">right</span> <span class="o">=</span> <span class="n">serialize_expression</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># ❌ Fixed spacing!</span>
</code></pre></div>
<p><strong>Status:</strong> ❌ Needs updating to use token positions</p>
<h2 id="implementation-plan">Implementation Plan<a class="headerlink" href="#implementation-plan" title="Permanent link">&para;</a></h2>
<h3 id="phase-1-update-serialization-to-use-positions">Phase 1: Update Serialization to Use Positions<a class="headerlink" href="#phase-1-update-serialization-to-use-positions" title="Permanent link">&para;</a></h3>
<p><strong>Modify <code>ui_helpers.py</code> serialization functions:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">serialize_with_spacing</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Serialize AST node preserving original spacing&quot;&quot;&quot;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    <span class="n">prev_end_column</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>        <span class="c1"># Calculate spaces from previous token</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">&gt;</span> <span class="n">prev_end_column</span><span class="p">:</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>            <span class="n">spaces</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">-</span> <span class="n">prev_end_column</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">spaces</span><span class="p">)</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>        <span class="c1"># Add token value</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>        <span class="n">prev_end_column</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</code></pre></div>
<p><strong>Update each serialize function:</strong>
- <code>serialize_statement()</code> - Use token positions
- <code>serialize_expression()</code> - Use token positions
- <code>serialize_binary_op()</code> - Use token positions
- <code>serialize_variable()</code> - Use token positions
- etc.</p>
<h3 id="phase-2-store-token-sequences-in-ast-nodes">Phase 2: Store Token Sequences in AST Nodes<a class="headerlink" href="#phase-2-store-token-sequences-in-ast-nodes" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> AST nodes don't currently store the full sequence of tokens, only key tokens (like operator).</p>
<p><strong>Solution:</strong> Add <code>tokens</code> list to AST nodes during parsing.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">BinaryOpNode</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span> <span class="ow">or</span> <span class="p">[]</span>  <span class="c1"># NEW: All tokens for this node</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="c1"># During parsing:</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="k">def</span><span class="w"> </span><span class="nf">parse_binary_op</span><span class="p">():</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>    <span class="n">tokens_used</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Track all tokens consumed</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="n">left</span> <span class="o">=</span> <span class="n">parse_term</span><span class="p">(</span><span class="n">tokens_used</span><span class="p">)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>    <span class="n">op_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_token</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="n">tokens_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_token</span><span class="p">)</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">advance</span><span class="p">()</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="n">right</span> <span class="o">=</span> <span class="n">parse_term</span><span class="p">(</span><span class="n">tokens_used</span><span class="p">)</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="k">return</span> <span class="n">BinaryOpNode</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">op_token</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">tokens</span><span class="o">=</span><span class="n">tokens_used</span><span class="p">)</span>
</code></pre></div>
<h3 id="phase-3-handle-edge-cases">Phase 3: Handle Edge Cases<a class="headerlink" href="#phase-3-handle-edge-cases" title="Permanent link">&para;</a></h3>
<p><strong>Edge Case 1: Nested Expressions</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nl">10</span><span class="w"> </span><span class="vg">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="il">2</span>
</code></pre></div>
Need to preserve spacing within and around parentheses.</p>
<p><strong>Edge Case 2: Multi-line Statements</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nl">10</span><span class="w"> </span><span class="kr">IF</span><span class="w"> </span><span class="vg">X</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="il">5</span><span class="w"> </span><span class="kr">THEN</span><span class="w"> </span><span class="kr">PRINT</span><span class="w"> </span><span class="s2">&quot;YES&quot;</span><span class="o">:</span><span class="w"> </span><span class="kr">GOTO</span><span class="w"> </span><span class="nl">100</span>
</code></pre></div>
Need to preserve spacing across multiple statement parts.</p>
<p><strong>Edge Case 3: Comments</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nl">10</span><span class="w"> </span><span class="vg">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span><span class="w"> </span><span class="c1">&#39; Add three</span>
</code></pre></div>
Need to preserve spacing before comment.</p>
<p><strong>Edge Case 4: String Literals</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nl">10</span><span class="w"> </span><span class="kr">PRINT</span><span class="w"> </span><span class="s2">&quot;Hello   World&quot;</span>
</code></pre></div>
Spaces inside strings must be preserved (already handled by token value).</p>
<h3 id="phase-4-fallback-for-generated-code">Phase 4: Fallback for Generated Code<a class="headerlink" href="#phase-4-fallback-for-generated-code" title="Permanent link">&para;</a></h3>
<p><strong>Problem:</strong> When code is generated (not parsed from source), there are no token positions.</p>
<p><strong>Examples:</strong>
- RENUM generates new line numbers
- User types new line without parsing first
- Code synthesized by commands</p>
<p><strong>Solution:</strong> Provide fallback to pretty printing when positions unavailable.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">serialize_node</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">has_token_positions</span><span class="p">():</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>        <span class="k">return</span> <span class="n">serialize_with_spacing</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>        <span class="k">return</span> <span class="n">serialize_pretty_print</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>  <span class="c1"># Fallback</span>
</code></pre></div>
<h3 id="phase-5-handle-renum-special-cases">Phase 5: Handle RENUM Special Cases<a class="headerlink" href="#phase-5-handle-renum-special-cases" title="Permanent link">&para;</a></h3>
<p><strong>Critical:</strong> RENUM changes line numbers in TWO places:</p>
<ol>
<li><strong>Line number at start of line:</strong> <code>10 X=Y</code> → <code>100 X=Y</code></li>
<li><strong>Line number references in statements:</strong></li>
<li><code>GOTO 10</code> → <code>GOTO 100</code></li>
<li><code>GOSUB 10</code> → <code>GOSUB 100</code></li>
<li><code>IF ERL = 10 THEN</code> → <code>IF ERL = 100 THEN</code></li>
<li><code>ON X GOTO 10, 20, 30</code> → <code>ON X GOTO 100, 200, 300</code></li>
<li><code>RESTORE 10</code> → <code>RESTORE 100</code></li>
<li><code>RESUME 10</code> → <code>RESUME 100</code></li>
</ol>
<p><strong>The Problem:</strong>
When line number length changes, it affects column positions of ALL subsequent tokens on that line.</p>
<p><strong>Example 1: Line number at start</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nl">Original:</span><span class="w">     </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nl">Positions:</span><span class="w">    </span><span class="o">^</span><span class="w">  </span><span class="o">^</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="o">^</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">              </span><span class="il">0</span><span class="w">  </span><span class="il">3</span><span class="w"> </span><span class="il">5</span><span class="w"> </span><span class="il">7</span><span class="w"> </span><span class="il">9</span><span class="w"> </span><span class="il">11</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="vg">After</span><span class="w"> </span><span class="nl">RENUM:</span><span class="w">  </span><span class="il">1000</span><span class="w"> </span><span class="vg">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">              </span><span class="o">^</span><span class="w">    </span><span class="o">?</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">              </span><span class="il">0</span><span class="w">    </span><span class="vg">Should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">at</span><span class="w"> </span><span class="il">5</span><span class="p">,</span><span class="w"> </span><span class="vg">but</span><span class="w"> </span><span class="vg">stored</span><span class="w"> </span><span class="vg">position</span><span class="w"> </span><span class="vg">is</span><span class="w"> </span><span class="il">3</span><span class="o">!</span>
</code></pre></div></p>
<p><strong>Example 2: GOTO target</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nl">Original:</span><span class="w">     </span><span class="il">20</span><span class="w"> </span><span class="kr">GOTO</span><span class="w"> </span><span class="nl">10</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="nl">Positions:</span><span class="w">       </span><span class="o">^</span><span class="w">    </span><span class="o">^</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">                 </span><span class="il">3</span><span class="w">    </span><span class="il">8</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="vg">After</span><span class="w"> </span><span class="nl">RENUM:</span><span class="w">  </span><span class="il">200</span><span class="w"> </span><span class="kr">GOTO</span><span class="w"> </span><span class="nl">100</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">              </span><span class="o">^</span><span class="w">   </span><span class="o">?</span><span class="w">    </span><span class="o">?</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">              </span><span class="il">0</span><span class="w">   </span><span class="vg">Should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="il">4</span><span class="p">,</span><span class="w"> </span><span class="vg">but</span><span class="w"> </span><span class="vg">stored</span><span class="w"> </span><span class="vg">is</span><span class="w"> </span><span class="il">3</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">                       </span><span class="vg">Should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="il">9</span><span class="p">,</span><span class="w"> </span><span class="vg">but</span><span class="w"> </span><span class="vg">stored</span><span class="w"> </span><span class="vg">is</span><span class="w"> </span><span class="il">8</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">                       </span><span class="vg">And</span><span class="w"> </span><span class="nl">worse:</span><span class="w"> </span><span class="s2">&quot;100&quot;</span><span class="w"> </span><span class="vg">is</span><span class="w"> </span><span class="il">3</span><span class="w"> </span><span class="vg">chars</span><span class="p">,</span><span class="w"> </span><span class="vg">not</span><span class="w"> </span><span class="s2">&quot;10&quot;</span><span class="w"> </span><span class="p">(</span><span class="il">2</span><span class="w"> </span><span class="vg">chars</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Solutions:</strong></p>
<p><strong>Option A: Invalidate positions (RECOMMENDED for Phase 1)</strong>
- Mark all RENUMed lines as "no positions"
- Fall back to pretty printing
- Simple, reliable, acceptable UX</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">renum_program</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">program</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>        <span class="n">line</span><span class="o">.</span><span class="n">invalidate_positions</span><span class="p">()</span>  <span class="c1"># Force pretty printing</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        <span class="c1"># ... do renumbering ...</span>
</code></pre></div>
<p><strong>Option B: Adjust all positions</strong>
- Calculate delta for line number change
- Walk AST and adjust all token positions
- Complex, error-prone, but preserves spacing</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">adjust_positions_after_renum</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">old_line_num</span><span class="p">,</span> <span class="n">new_line_num</span><span class="p">):</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">old_line_num</span><span class="p">))</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_line_num</span><span class="p">))</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>    <span class="n">delta</span> <span class="o">=</span> <span class="n">new_len</span> <span class="o">-</span> <span class="n">old_len</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="c1"># Adjust all tokens in line</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">all_tokens</span><span class="p">():</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">&gt;</span> <span class="n">old_len</span><span class="p">:</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>            <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">+=</span> <span class="n">delta</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="c1"># Find and adjust all line number references</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">find_all_nodes</span><span class="p">(</span><span class="n">LineNumberNode</span><span class="p">):</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">old_line_num</span><span class="p">:</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>            <span class="n">node</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">new_line_num</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>            <span class="c1"># Adjust position of this line number reference</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>            <span class="n">old_ref_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">old_line_num</span><span class="p">))</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>            <span class="n">new_ref_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_line_num</span><span class="p">))</span>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>            <span class="n">ref_delta</span> <span class="o">=</span> <span class="n">new_ref_len</span> <span class="o">-</span> <span class="n">old_ref_len</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>            <span class="c1"># Adjust all subsequent tokens on this line</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a>            <span class="c1"># ... complex logic ...</span>
</code></pre></div>
<p><strong>Recommendation:</strong> Do Option B (adjust all positions). We're already 57,000 lines deep into a Python implementation of a 30-year-dead language with a fancy modern UI - why half-ass the spacing preservation? Do it right!</p>
<p><strong>Implementation approach for Option B:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">renum_line_and_adjust_positions</span><span class="p">(</span><span class="n">line_node</span><span class="p">,</span> <span class="n">old_num</span><span class="p">,</span> <span class="n">new_num</span><span class="p">,</span> <span class="n">line_num_map</span><span class="p">):</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="sd">    Renumber a line and adjust all token positions to preserve spacing.</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="sd">    Args:</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="sd">        line_node: The AST node for the line</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="sd">        old_num: Old line number</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="sd">        new_num: New line number</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="sd">        line_num_map: Dict mapping old line numbers to new ones</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="n">changes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Track all position changes</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="c1"># Step 1: Adjust line number at start</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">old_num</span><span class="p">))</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_num</span><span class="p">))</span>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="n">line_delta</span> <span class="o">=</span> <span class="n">new_len</span> <span class="o">-</span> <span class="n">old_len</span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>    <span class="k">if</span> <span class="n">line_delta</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>        <span class="c1"># Shift all tokens after line number</span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line_node</span><span class="o">.</span><span class="n">all_tokens</span><span class="p">():</span>
<a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">&gt;=</span> <span class="n">old_len</span><span class="p">:</span>
<a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>                <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">+=</span> <span class="n">line_delta</span>
<a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>                <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="n">new_num</span><span class="si">}</span><span class="s2">: shifted token &#39;</span><span class="si">{</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; by </span><span class="si">{</span><span class="n">line_delta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>
<a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>    <span class="c1"># Step 2: Find and update all line number references</span>
<a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>    <span class="k">for</span> <span class="n">ref_node</span> <span class="ow">in</span> <span class="n">line_node</span><span class="o">.</span><span class="n">find_all_line_number_refs</span><span class="p">():</span>
<a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>        <span class="n">old_target</span> <span class="o">=</span> <span class="n">ref_node</span><span class="o">.</span><span class="n">line_number</span>
<a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>        <span class="n">new_target</span> <span class="o">=</span> <span class="n">line_num_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">old_target</span><span class="p">,</span> <span class="n">old_target</span><span class="p">)</span>
<a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>
<a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>        <span class="k">if</span> <span class="n">old_target</span> <span class="o">!=</span> <span class="n">new_target</span><span class="p">:</span>
<a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>            <span class="c1"># Update the line number value</span>
<a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>            <span class="n">old_target_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">old_target</span><span class="p">))</span>
<a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>            <span class="n">new_target_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_target</span><span class="p">))</span>
<a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>            <span class="n">ref_delta</span> <span class="o">=</span> <span class="n">new_target_len</span> <span class="o">-</span> <span class="n">old_target_len</span>
<a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>
<a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>            <span class="k">if</span> <span class="n">ref_delta</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>                <span class="c1"># Find token for this line number reference</span>
<a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>                <span class="n">ref_token</span> <span class="o">=</span> <span class="n">ref_node</span><span class="o">.</span><span class="n">token</span>
<a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>
<a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>                <span class="c1"># Shift all tokens AFTER this reference</span>
<a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">line_node</span><span class="o">.</span><span class="n">all_tokens</span><span class="p">():</span>
<a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>                    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">&gt;</span> <span class="n">ref_token</span><span class="o">.</span><span class="n">column</span> <span class="o">+</span> <span class="n">old_target_len</span><span class="p">:</span>
<a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>                        <span class="n">token</span><span class="o">.</span><span class="n">column</span> <span class="o">+=</span> <span class="n">ref_delta</span>
<a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>                        <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Line </span><span class="si">{</span><span class="n">new_num</span><span class="si">}</span><span class="s2">: shifted token &#39;</span><span class="si">{</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; by </span><span class="si">{</span><span class="n">ref_delta</span><span class="si">}</span><span class="s2"> after target update&quot;</span><span class="p">)</span>
<a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>
<a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>                <span class="c1"># Update the reference value and token</span>
<a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>                <span class="n">ref_node</span><span class="o">.</span><span class="n">line_number</span> <span class="o">=</span> <span class="n">new_target</span>
<a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a>                <span class="n">ref_token</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_target</span><span class="p">)</span>
<a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a>
<a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a>    <span class="k">return</span> <span class="n">changes</span>
<a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a>
<a id="__codelineno-17-52" name="__codelineno-17-52" href="#__codelineno-17-52"></a><span class="k">def</span><span class="w"> </span><span class="nf">renum_program_preserve_spacing</span><span class="p">(</span><span class="n">program</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
<a id="__codelineno-17-53" name="__codelineno-17-53" href="#__codelineno-17-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-17-54" name="__codelineno-17-54" href="#__codelineno-17-54"></a><span class="sd">    Renumber entire program while preserving spacing.</span>
<a id="__codelineno-17-55" name="__codelineno-17-55" href="#__codelineno-17-55"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-17-56" name="__codelineno-17-56" href="#__codelineno-17-56"></a>    <span class="c1"># Build mapping of old -&gt; new line numbers</span>
<a id="__codelineno-17-57" name="__codelineno-17-57" href="#__codelineno-17-57"></a>    <span class="n">old_line_nums</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-17-58" name="__codelineno-17-58" href="#__codelineno-17-58"></a>    <span class="n">line_num_map</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-17-59" name="__codelineno-17-59" href="#__codelineno-17-59"></a>    <span class="n">new_num</span> <span class="o">=</span> <span class="n">start</span>
<a id="__codelineno-17-60" name="__codelineno-17-60" href="#__codelineno-17-60"></a>
<a id="__codelineno-17-61" name="__codelineno-17-61" href="#__codelineno-17-61"></a>    <span class="k">for</span> <span class="n">old_num</span> <span class="ow">in</span> <span class="n">old_line_nums</span><span class="p">:</span>
<a id="__codelineno-17-62" name="__codelineno-17-62" href="#__codelineno-17-62"></a>        <span class="n">line_num_map</span><span class="p">[</span><span class="n">old_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_num</span>
<a id="__codelineno-17-63" name="__codelineno-17-63" href="#__codelineno-17-63"></a>        <span class="n">new_num</span> <span class="o">+=</span> <span class="n">step</span>
<a id="__codelineno-17-64" name="__codelineno-17-64" href="#__codelineno-17-64"></a>
<a id="__codelineno-17-65" name="__codelineno-17-65" href="#__codelineno-17-65"></a>    <span class="c1"># Process lines in order (important for cascading changes)</span>
<a id="__codelineno-17-66" name="__codelineno-17-66" href="#__codelineno-17-66"></a>    <span class="n">all_changes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-17-67" name="__codelineno-17-67" href="#__codelineno-17-67"></a>    <span class="k">for</span> <span class="n">old_num</span> <span class="ow">in</span> <span class="n">old_line_nums</span><span class="p">:</span>
<a id="__codelineno-17-68" name="__codelineno-17-68" href="#__codelineno-17-68"></a>        <span class="n">line_node</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">old_num</span><span class="p">]</span>
<a id="__codelineno-17-69" name="__codelineno-17-69" href="#__codelineno-17-69"></a>        <span class="n">new_num</span> <span class="o">=</span> <span class="n">line_num_map</span><span class="p">[</span><span class="n">old_num</span><span class="p">]</span>
<a id="__codelineno-17-70" name="__codelineno-17-70" href="#__codelineno-17-70"></a>
<a id="__codelineno-17-71" name="__codelineno-17-71" href="#__codelineno-17-71"></a>        <span class="n">changes</span> <span class="o">=</span> <span class="n">renum_line_and_adjust_positions</span><span class="p">(</span><span class="n">line_node</span><span class="p">,</span> <span class="n">old_num</span><span class="p">,</span> <span class="n">new_num</span><span class="p">,</span> <span class="n">line_num_map</span><span class="p">)</span>
<a id="__codelineno-17-72" name="__codelineno-17-72" href="#__codelineno-17-72"></a>        <span class="n">all_changes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>
<a id="__codelineno-17-73" name="__codelineno-17-73" href="#__codelineno-17-73"></a>
<a id="__codelineno-17-74" name="__codelineno-17-74" href="#__codelineno-17-74"></a>        <span class="c1"># Update the line number in the program</span>
<a id="__codelineno-17-75" name="__codelineno-17-75" href="#__codelineno-17-75"></a>        <span class="k">if</span> <span class="n">old_num</span> <span class="o">!=</span> <span class="n">new_num</span><span class="p">:</span>
<a id="__codelineno-17-76" name="__codelineno-17-76" href="#__codelineno-17-76"></a>            <span class="k">del</span> <span class="n">program</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">old_num</span><span class="p">]</span>
<a id="__codelineno-17-77" name="__codelineno-17-77" href="#__codelineno-17-77"></a>            <span class="n">program</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">new_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_node</span>
<a id="__codelineno-17-78" name="__codelineno-17-78" href="#__codelineno-17-78"></a>            <span class="n">line_node</span><span class="o">.</span><span class="n">line_number</span> <span class="o">=</span> <span class="n">new_num</span>
<a id="__codelineno-17-79" name="__codelineno-17-79" href="#__codelineno-17-79"></a>
<a id="__codelineno-17-80" name="__codelineno-17-80" href="#__codelineno-17-80"></a>    <span class="k">return</span> <span class="n">all_changes</span>  <span class="c1"># Return for debugging/logging</span>
</code></pre></div>
<p><strong>Key insight:</strong> Process each line independently, tracking cumulative position adjustments:
1. Adjust for line number length change at start
2. Find each line number reference (GOTO, GOSUB, etc.)
3. For each reference that changes length, shift all subsequent tokens</p>
<p>This preserves the user's exact spacing even through RENUM!</p>
<p><strong>All statements that reference line numbers:</strong>
- <code>GOTO line</code>
- <code>GOSUB line</code>
- <code>THEN line</code> (in IF statement)
- <code>ELSE line</code> (in IF statement)
- <code>ON expr GOTO line1, line2, ...</code>
- <code>ON expr GOSUB line1, line2, ...</code>
- <code>RESTORE line</code>
- <code>RESUME line</code>
- <code>ERL = line</code> (in expressions comparing error line)
- <code>DELETE line</code> or <code>DELETE line1-line2</code>
- <code>LIST line</code> or <code>LIST line1-line2</code></p>
<p>All of these need position adjustment if we do Option B.</p>
<h2 id="benefits">Benefits<a class="headerlink" href="#benefits" title="Permanent link">&para;</a></h2>
<h3 id="1-preserves-user-intent">1. Preserves User Intent<a class="headerlink" href="#1-preserves-user-intent" title="Permanent link">&para;</a></h3>
<p>User's spacing choices reflect their style and intentions:
- Compact: <code>X=Y+3</code> (user prefers tight)
- Spacious: <code>X = Y + 3</code> (user prefers readable)
- Mixed: <code>X=Y + 3</code> (user's preference)</p>
<h3 id="2-no-surprising-changes">2. No Surprising Changes<a class="headerlink" href="#2-no-surprising-changes" title="Permanent link">&para;</a></h3>
<p>When user saves/loads/renumbers, their code looks the same (except line numbers).</p>
<h3 id="3-respects-coding-style">3. Respects Coding Style<a class="headerlink" href="#3-respects-coding-style" title="Permanent link">&para;</a></h3>
<p>Different users have different preferences. Don't force a standard.</p>
<h3 id="4-related-to-case-preservation">4. Related to Case Preservation<a class="headerlink" href="#4-related-to-case-preservation" title="Permanent link">&para;</a></h3>
<p>Both preserve user's original input:
- Case-preserving variables: <code>TargetAngle</code> not <code>targetangle</code>
- Spacing preservation: <code>X=Y+3</code> not <code>X = Y + 3</code></p>
<p>Same philosophy: <strong>Maintain fidelity to source code</strong></p>
<h2 id="comparison-with-pretty-printing">Comparison with Pretty Printing<a class="headerlink" href="#comparison-with-pretty-printing" title="Permanent link">&para;</a></h2>
<h3 id="current-pretty-print-approach">Current (Pretty Print) Approach<a class="headerlink" href="#current-pretty-print-approach" title="Permanent link">&para;</a></h3>
<p><strong>Pros:</strong>
- Consistent formatting
- Easy to implement
- No need to track positions</p>
<p><strong>Cons:</strong>
- Loses user's formatting ❌
- Surprising changes to code ❌
- Forces one style on everyone ❌</p>
<h3 id="proposed-position-based-approach">Proposed (Position-Based) Approach<a class="headerlink" href="#proposed-position-based-approach" title="Permanent link">&para;</a></h3>
<p><strong>Pros:</strong>
- Preserves user's formatting ✅
- No surprising changes ✅
- Respects user's style ✅
- Information already available ✅</p>
<p><strong>Cons:</strong>
- Slightly more complex
- Need fallback for generated code
- Need to store token sequences</p>
<p><strong>Verdict:</strong> Position-based is clearly superior for user experience.</p>
<h2 id="related-todos">Related TODOs<a class="headerlink" href="#related-todos" title="Permanent link">&para;</a></h2>
<h3 id="pretty_printer_spacing_todomd">PRETTY_PRINTER_SPACING_TODO.md<a class="headerlink" href="#pretty_printer_spacing_todomd" title="Permanent link">&para;</a></h3>
<p>The pretty printer spacing TODO becomes <strong>optional</strong> if we preserve spacing:
- Spacing options only needed for <strong>generated code</strong> (fallback)
- User's code automatically uses their spacing
- Still useful for: RENUM, NEW, auto-generated lines</p>
<p><strong>Update:</strong> Pretty printer becomes fallback, not primary serialization method.</p>
<h3 id="type_suffix_serialization-completed-v1085">TYPE_SUFFIX_SERIALIZATION (Completed v1.0.85)<a class="headerlink" href="#type_suffix_serialization-completed-v1085" title="Permanent link">&para;</a></h3>
<p>Similar problem and solution:
- <strong>Problem:</strong> Serialization added type suffixes user didn't type
- <strong>Solution:</strong> Track explicit vs inferred suffixes, only output explicit
- <strong>Same principle:</strong> Preserve what user actually typed</p>
<h3 id="case_preserving_variables_todomd">CASE_PRESERVING_VARIABLES_TODO.md<a class="headerlink" href="#case_preserving_variables_todomd" title="Permanent link">&para;</a></h3>
<p>Same philosophy:
- Preserve case user typed: <code>TargetAngle</code> not <code>targetangle</code>
- Preserve spacing user typed: <code>X=Y+3</code> not <code>X = Y + 3</code></p>
<p><strong>Common theme:</strong> Maintain fidelity to source code</p>
<h2 id="testing-plan">Testing Plan<a class="headerlink" href="#testing-plan" title="Permanent link">&para;</a></h2>
<h3 id="test-cases">Test Cases<a class="headerlink" href="#test-cases" title="Permanent link">&para;</a></h3>
<p><strong>Test 1: Compact spacing</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nl">Input:</span><span class="w">  </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="vg">Y</span><span class="o">+</span><span class="il">3</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nl">Output:</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="vg">Y</span><span class="o">+</span><span class="il">3</span><span class="w">  </span><span class="err">✅</span><span class="w"> </span><span class="vg">Preserved</span>
</code></pre></div></p>
<p><strong>Test 2: Spacious spacing</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nl">Input:</span><span class="w">  </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="nl">Output:</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span><span class="w">  </span><span class="err">✅</span><span class="w"> </span><span class="vg">Preserved</span>
</code></pre></div></p>
<p><strong>Test 3: Mixed spacing</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="nl">Input:</span><span class="w">  </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span><span class="o">*</span><span class="vg">Z</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="nl">Output:</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span><span class="o">*</span><span class="vg">Z</span><span class="w">  </span><span class="err">✅</span><span class="w"> </span><span class="vg">Preserved</span>
</code></pre></div></p>
<p><strong>Test 4: Parentheses</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nl">Input:</span><span class="w">  </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="p">(</span><span class="vg">Y</span><span class="o">+</span><span class="il">3</span><span class="p">)</span><span class="o">*</span><span class="il">2</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nl">Output:</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="p">(</span><span class="vg">Y</span><span class="o">+</span><span class="il">3</span><span class="p">)</span><span class="o">*</span><span class="il">2</span><span class="w">  </span><span class="err">✅</span><span class="w"> </span><span class="vg">Preserved</span>
</code></pre></div></p>
<p><strong>Test 5: Multiple statements</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nl">Input:</span><span class="w">  </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="il">1</span><span class="o">:</span><span class="vg">Y</span><span class="o">=</span><span class="il">2</span><span class="o">:</span><span class="kr">PRINT</span><span class="w"> </span><span class="vg">X</span><span class="p">,</span><span class="vg">Y</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="nl">Output:</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="il">1</span><span class="o">:</span><span class="vg">Y</span><span class="o">=</span><span class="il">2</span><span class="o">:</span><span class="kr">PRINT</span><span class="w"> </span><span class="vg">X</span><span class="p">,</span><span class="vg">Y</span><span class="w">  </span><span class="err">✅</span><span class="w"> </span><span class="vg">Preserved</span>
</code></pre></div></p>
<p><strong>Test 6: String literals</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="nl">Input:</span><span class="w">  </span><span class="il">10</span><span class="w"> </span><span class="kr">PRINT</span><span class="w"> </span><span class="s2">&quot;Hello   World&quot;</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="nl">Output:</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="kr">PRINT</span><span class="w"> </span><span class="s2">&quot;Hello   World&quot;</span><span class="w">  </span><span class="err">✅</span><span class="w"> </span><span class="vg">Preserved</span>
</code></pre></div></p>
<p><strong>Test 7: Comments</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nl">Input:</span><span class="w">  </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="vg">Y</span><span class="o">+</span><span class="il">3</span><span class="w"> </span><span class="c1">&#39; Calculate</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nl">Output:</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="vg">Y</span><span class="o">+</span><span class="il">3</span><span class="w"> </span><span class="c1">&#39; Calculate  ✅ Preserved</span>
</code></pre></div></p>
<p><strong>Test 8: Generated code (fallback)</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nl">RENUM:</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="o">=</span><span class="vg">Y</span><span class="o">+</span><span class="il">3</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nl">Output:</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="vg">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">3</span><span class="w">  </span><span class="err">✅</span><span class="w"> </span><span class="vg">Pretty</span><span class="w"> </span><span class="vg">printed</span><span class="w"> </span><span class="p">(</span><span class="vg">no</span><span class="w"> </span><span class="vg">positions</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Test 9: Round-trip</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="vg">Load</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="vg">Parse</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="vg">Serialize</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="vg">Parse</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="vg">Serialize</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="nl">Result:</span><span class="w"> </span><span class="vg">Should</span><span class="w"> </span><span class="vg">match</span><span class="w"> </span><span class="vg">original</span><span class="w"> </span><span class="vg">after</span><span class="w"> </span><span class="vg">first</span><span class="w"> </span><span class="vg">serialize</span>
</code></pre></div></p>
<h3 id="integration-tests">Integration Tests<a class="headerlink" href="#integration-tests" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Save/Load cycle:</strong> Load program, save it, compare</li>
<li><strong>RENUM:</strong> Renumber, check spacing preserved (except line numbers)</li>
<li><strong>Edit and refresh:</strong> Edit line, refresh, check spacing</li>
<li><strong>Copy/paste:</strong> Copy lines, paste, check spacing</li>
<li><strong>Variable window:</strong> Check case and spacing consistency</li>
</ol>
<h2 id="implementation-files">Implementation Files<a class="headerlink" href="#implementation-files" title="Permanent link">&para;</a></h2>
<h3 id="files-to-modify">Files to Modify<a class="headerlink" href="#files-to-modify" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>src/ui/ui_helpers.py</code></strong> - Update serialization functions</li>
<li>Add <code>serialize_with_spacing()</code> function</li>
<li>Update all <code>serialize_*()</code> functions</li>
<li>
<p>Add fallback to pretty printing</p>
</li>
<li>
<p><strong><code>src/ast_nodes.py</code></strong> - Store token sequences</p>
</li>
<li>Add <code>tokens</code> field to AST node classes</li>
<li>
<p>Preserve tokens during AST construction</p>
</li>
<li>
<p><strong><code>src/parser.py</code></strong> - Track tokens during parsing</p>
</li>
<li>Collect tokens as they're consumed</li>
<li>Store in AST nodes</li>
</ul>
<h3 id="files-to-create">Files to Create<a class="headerlink" href="#files-to-create" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>tests/test_spacing_preservation.py</code></strong> - Test suite for spacing</li>
</ul>
<h3 id="files-to-update-related">Files to Update (Related)<a class="headerlink" href="#files-to-update-related" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>docs/dev/PRETTY_PRINTER_SPACING_TODO.md</code></strong> - Mark as fallback only</li>
<li>Pretty printer used for generated code</li>
<li>Not primary serialization method</li>
</ul>
<h2 id="migration-strategy">Migration Strategy<a class="headerlink" href="#migration-strategy" title="Permanent link">&para;</a></h2>
<h3 id="step-1-verify-token-positions-exist">Step 1: Verify Token Positions Exist<a class="headerlink" href="#step-1-verify-token-positions-exist" title="Permanent link">&para;</a></h3>
<ul>
<li>Audit lexer to ensure all tokens have positions</li>
<li>Add positions to any tokens that don't have them</li>
<li>Test that positions are accurate</li>
</ul>
<h3 id="step-2-add-token-storage-to-ast">Step 2: Add Token Storage to AST<a class="headerlink" href="#step-2-add-token-storage-to-ast" title="Permanent link">&para;</a></h3>
<ul>
<li>Add <code>tokens</code> field to AST node classes</li>
<li>Update parser to store tokens</li>
<li>Don't use positions yet (verify storage works)</li>
</ul>
<h3 id="step-3-implement-position-based-serialization">Step 3: Implement Position-Based Serialization<a class="headerlink" href="#step-3-implement-position-based-serialization" title="Permanent link">&para;</a></h3>
<ul>
<li>Create <code>serialize_with_spacing()</code> function</li>
<li>Test with simple expressions</li>
<li>Compare with original source</li>
</ul>
<h3 id="step-4-add-fallback">Step 4: Add Fallback<a class="headerlink" href="#step-4-add-fallback" title="Permanent link">&para;</a></h3>
<ul>
<li>Detect when positions unavailable</li>
<li>Fall back to pretty printing</li>
<li>Test both paths</li>
</ul>
<h3 id="step-5-roll-out-to-all-statements">Step 5: Roll Out to All Statements<a class="headerlink" href="#step-5-roll-out-to-all-statements" title="Permanent link">&para;</a></h3>
<ul>
<li>Update all statement types</li>
<li>Update all expression types</li>
<li>Test edge cases</li>
</ul>
<h3 id="step-6-integration-testing">Step 6: Integration Testing<a class="headerlink" href="#step-6-integration-testing" title="Permanent link">&para;</a></h3>
<ul>
<li>Test save/load cycles</li>
<li>Test RENUM</li>
<li>Test all UIs (CLI, curses, TK)</li>
</ul>
<h2 id="performance-considerations">Performance Considerations<a class="headerlink" href="#performance-considerations" title="Permanent link">&para;</a></h2>
<p><strong>Position-based serialization is actually FASTER than pretty printing:</strong></p>
<ul>
<li>Pretty printing: Traverse AST, apply spacing rules</li>
<li>Position-based: Traverse tokens, insert spaces from positions</li>
</ul>
<p><strong>Estimated impact:</strong> Negligible to positive (simpler logic)</p>
<h2 id="success-criteria">Success Criteria<a class="headerlink" href="#success-criteria" title="Permanent link">&para;</a></h2>
<ul>
<li>✅ User's spacing preserved in save/load cycle</li>
<li>✅ Spacing preserved through RENUM (except line numbers)</li>
<li>✅ No surprising formatting changes</li>
<li>✅ Fallback works for generated code</li>
<li>✅ All tests pass</li>
<li>✅ Performance not degraded</li>
</ul>
<h2 id="historical-context">Historical Context<a class="headerlink" href="#historical-context" title="Permanent link">&para;</a></h2>
<h3 id="classic-basic-interpreters">Classic BASIC Interpreters<a class="headerlink" href="#classic-basic-interpreters" title="Permanent link">&para;</a></h3>
<p><strong>MBASIC (MBASIC, GW-BASIC, etc.):</strong>
- Actually preserved spacing in line buffer!
- Stored lines as tokenized form + original text
- When LISTing, used original text (with spacing)
- Only re-formatted on RENUM or auto-number</p>
<p><strong>Modern Interpreters:</strong>
- Often use AST + pretty printer
- Loses spacing information
- Users complain about reformatting</p>
<p><strong>Our approach:</strong> Combine best of both:
- Modern AST architecture
- Classic spacing preservation</p>
<h2 id="notes">Notes<a class="headerlink" href="#notes" title="Permanent link">&para;</a></h2>
<ul>
<li>This is the RIGHT way to do it - preserve user's input</li>
<li>We already have the information (token positions)</li>
<li>Small implementation effort for big UX improvement</li>
<li>Aligns with case preservation and type suffix preservation</li>
<li>Users will appreciate their code staying the way they wrote it</li>
</ul>
<h2 id="priority-justification">Priority Justification<a class="headerlink" href="#priority-justification" title="Permanent link">&para;</a></h2>
<p><strong>HIGH Priority</strong> because:
1. User experience impact is significant
2. Data already available (token positions)
3. Implementation is straightforward
4. Related to recently completed type suffix fix
5. Part of "maintain fidelity to source" theme</p>
<p>Should be implemented after:
- Type suffix serialization fix ✅ (completed v1.0.85)</p>
<p>Should be implemented before:
- Settings system (doesn't depend on settings)
- Case-preserving variables (similar philosophy, should do together)</p>
<h2 id="implementation-notes">Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permanent link">&para;</a></h2>
<p>When implementing, be careful with:
1. <strong>Tab characters:</strong> How are column positions counted?
2. <strong>Multi-byte characters:</strong> UTF-8 handling in column positions
3. <strong>Line continuations:</strong> If we ever support them
4. <strong>Implicit line numbers:</strong> Auto-numbered lines don't have positions</p>
<p>Test thoroughly with:
- Different spacing styles
- Edge cases (empty statements, etc.)
- Round-trip save/load
- RENUM operation</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/avwohl/mbasic" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "navigation.tracking", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.action.edit"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>